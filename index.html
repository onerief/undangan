<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard & Etalase Bisnis Undangan Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fixed-header {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            z-index: 50; /* Z-index for header */
        }
        .theme-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        .theme-preview-container {
            border: 4px solid #f3f4f6;
            overflow: hidden;
            border-radius: 0.75rem;
            height: 350px; /* Fixed height for consistent display */
            position: relative;
        }
        .theme-mockup {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top; /* Show top part of the mockup */
        }
        /* Style for Modals */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999; /* Ensure modal is always on top */
        }
        .dashboard-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body>
    <!-- 1. FIXED HEADER -->
    <header class="fixed-header fixed top-0 left-0 w-full bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-gem text-xl text-indigo-600"></i>
                <h1 class="text-xl font-bold text-gray-800">Wedding.biz</h1>
            </div>
            <div id="authControls" class="space-x-2">
                <!-- Buttons change based on login status -->
                <button id="registerBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition duration-150">Daftar Akun</button>
                <button id="loginBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-300 transition duration-150">Masuk</button>
                
                <!-- Displayed after login -->
                <button id="dashboardBtn" class="hidden bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-600 transition duration-150"><i class="fas fa-tachometer-alt mr-1"></i> Dashboard</button>
                <button id="logoutBtn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-150"><i class="fas fa-sign-out-alt"></i> Keluar</button>
            </div>
        </div>
    </header>

    <!-- 2. MAIN CONTENT AREA (Etalase / Dashboard) -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20 pb-10">
        
        <!-- #################################### -->
        <!-- A. ETALASE (Default View) -->
        <!-- #################################### -->
        <section id="etalaseSection">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2">Semua Tema Premium</h2>
            <p class="text-lg text-gray-600 mb-8">Pilih desain yang paling sesuai dengan impian pernikahan Anda.</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                
                <!-- Tema 1: Jawa Keraton Premium (Link to tema_jawa.html) -->
                <div class="theme-card bg-white rounded-xl shadow-lg">
                    <div class="theme-preview-container">
                        <img src="https://placehold.co/400x700/583925/F0EAD6?text=Jawa+Keraton" alt="Preview Tema Jawa" class="theme-mockup">
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-900">Jawa Keraton Premium</h3>
                        <p class="text-gray-500 text-sm">Coklat Sogan, Emas Antik, Ornamen Keraton</p>
                        <a href="tema_jawa.html?user=USER_ID_PLACEHOLDER" class="mt-4 w-full block text-center bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition duration-150">Preview</a>
                    </div>
                </div>

                <!-- Tema 2: Minimalis Modern -->
                <div class="theme-card bg-white rounded-xl shadow-lg">
                    <div class="theme-preview-container">
                        <img src="https://placehold.co/400x700/1a1a1a/ffffff?text=Minimalis+Modern" alt="Preview Tema Minimalis" class="theme-mockup">
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-900">Minimalis Modern</h3>
                        <p class="text-gray-500 text-sm">Hitam Putih, Tipografi Bersih, Elegan</p>
                        <a href="tema_minimalis.html?user=USER_ID_PLACEHOLDER" class="mt-4 w-full block text-center bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition duration-150">Preview</a>
                    </div>
                </div>

                <!-- Tema 3: Luxury Black & Gold -->
                <div class="theme-card bg-white rounded-xl shadow-lg">
                    <div class="theme-preview-container">
                        <img src="https://placehold.co/400x700/111827/FFD700?text=Black+Gold+Luxury" alt="Preview Tema Black Gold" class="theme-mockup">
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-900">Luxury Black & Gold</h3>
                        <p class="text-gray-500 text-sm">Formal, Glamor, Aksen Metalik Emas</p>
                        <a href="tema_gold_black.html?user=USER_ID_PLACEHOLDER" class="mt-4 w-full block text-center bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition duration-150">Preview</a>
                    </div>
                </div>

                <!-- Tema 4: Classic Navy Elegance -->
                <div class="theme-card bg-white rounded-xl shadow-lg">
                    <div class="theme-preview-container">
                        <img src="https://placehold.co/400x700/001F3F/C0C0C0?text=Classic+Navy" alt="Preview Tema Classic Navy" class="theme-mockup">
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-900">Classic Navy Elegance</h3>
                        <p class="text-gray-500 text-sm">Navy Blue, Perak, Interaktif Parallax</p>
                        <a href="tema_classic_vintage.html?user=USER_ID_PLACEHOLDER" class="mt-4 w-full block text-center bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition duration-150">Preview</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- #################################### -->
        <!-- B. DASHBOARD PELANGGAN (Hidden by default) -->
        <!-- #################################### -->
        <section id="dashboardSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-900">Dashboard Undangan Anda</h2>
                <p id="dashboardUserId" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Kolom Kiri: Form Input Data -->
                <div class="lg:col-span-2 dashboard-container p-6">
                    <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Input Data Undangan</h3>
                    <p class="text-sm text-gray-600 mb-6">Isi semua detail di bawah ini, lalu klik tombol simpan di akhir form. Data Anda akan terisi otomatis di preview tema.</p>

                    <form id="invitationForm">
                        
                        <!-- 1. Detail Mempelai -->
                        <div class="mb-8 border-b pb-4">
                            <h4 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-user-friends mr-2"></i> Detail Mempelai</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="wanitaPanggilan" placeholder="Nama Panggilan Wanita (Cth: Vuah)" required class="w-full p-3 border rounded-lg">
                                <input type="text" name="priaPanggilan" placeholder="Nama Panggilan Pria (Cth: Arif)" required class="w-full p-3 border rounded-lg">
                                <input type="text" name="wanitaLengkap" placeholder="Nama Lengkap Wanita" required class="w-full p-3 border rounded-lg">
                                <input type="text" name="priaLengkap" placeholder="Nama Lengkap Pria" required class="w-full p-3 border rounded-lg">
                            </div>
                            <textarea name="wanitaOrtu" placeholder="Ortu Wanita (Cth: Putri Bpk. Sairin & Ibu Kasiyah)" required class="w-full p-3 border rounded-lg mt-4" rows="2"></textarea>
                            <textarea name="priaOrtu" placeholder="Ortu Pria (Cth: Putra Bpk. Buyung & Ibu Rosilawati)" required class="w-full p-3 border rounded-lg mt-2" rows="2"></textarea>
                        </div>
                        
                        <!-- 2. Detail Acara -->
                        <div class="mb-8 border-b pb-4">
                            <h4 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-calendar-alt mr-2"></i> Detail Acara & Lokasi</h4>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal & Waktu Akad:</label>
                            <input type="datetime-local" name="tglAkad" required class="w-full p-3 border rounded-lg mb-4">
                            
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal & Waktu Resepsi:</label>
                            <input type="datetime-local" name="tglResepsi" required class="w-full p-3 border rounded-lg mb-4">

                            <input type="text" name="alamatAcara" placeholder="Nama Gedung/Tempat & Alamat Acara" required class="w-full p-3 border rounded-lg mt-2">
                            <input type="url" name="linkMaps" placeholder="Link Google Maps (Cth: https://maps.app.goo.gl/...) " class="w-full p-3 border rounded-lg mt-2">
                        </div>
                        
                        <!-- 3. Detail Kado -->
                        <div class="mb-8">
                            <h4 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-gift mr-2"></i> Amplop Digital & Kado</h4>
                            <input type="text" name="rekArif" placeholder="Rekening Pria (Cth: ShopeePay 089646800884)" required class="w-full p-3 border rounded-lg mb-2">
                            <input type="text" name="rekVuah" placeholder="Rekening Wanita (Cth: Sea Bank 901498159610)" required class="w-full p-3 border rounded-lg mb-2">
                            <textarea name="alamatKado" placeholder="Alamat Pengiriman Kado Fisik (Lengkap)" required class="w-full p-3 border rounded-lg mt-2" rows="3"></textarea>
                        </div>

                        <button type="submit" id="saveDataBtn" class="w-full bg-emerald-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-emerald-700 transition duration-150">
                            <i class="fas fa-save mr-2"></i> Simpan Data Undangan
                        </button>
                        <p id="saveStatus" class="mt-3 text-center text-sm font-medium"></p>
                    </form>
                </div>

                <!-- Kolom Kanan: Preview Link -->
                <div class="lg:col-span-1">
                    <div class="dashboard-container p-6 bg-indigo-50 border-l-4 border-indigo-500">
                        <h3 class="text-2xl font-semibold text-indigo-700 mb-4">Link Preview</h3>
                        <p class="text-gray-600 mb-4 text-sm">Cek hasil input data Anda di tema yang berbeda:</p>
                        
                        <div id="previewLinks" class="space-y-3">
                            <!-- Links are updated by JS after user logs in -->
                        </div>
                        
                        <div class="mt-6 border-t pt-4">
                             <h4 class="text-lg font-bold text-gray-800 mb-2">Link Undangan Tamu</h4>
                             <p class="text-sm text-gray-600 mb-2">Gunakan link ini dan tambahkan <code>?to=Nama_Tamu</code> di belakangnya saat menyebar.</p>
                             <div class="bg-white p-3 border rounded-lg flex items-center">
                                <code id="userBaseLink" class="flex-grow text-xs truncate">Loading...</code>
                                <button id="copyBaseLinkBtn" class="ml-2 text-indigo-500 hover:text-indigo-700 text-sm"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Modal Pendaftaran / Login -->
        <div id="authModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop transition-opacity duration-300">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transition-all duration-300" style="z-index: 1000;">
                <h3 class="text-2xl font-bold mb-4 text-gray-800" id="authTitle">Daftar Akun</h3>
                <form id="authForm">
                    <div id="registerFields">
                        <input type="text" name="name" id="authName" placeholder="Nama Lengkap" class="w-full p-3 border rounded-lg mb-3" required>
                        <input type="tel" name="phone" id="authPhone" placeholder="Nomor HP" class="w-full p-3 border rounded-lg mb-3" required>
                    </div>
                    <input type="email" name="email" id="authEmail" placeholder="Email" class="w-full p-3 border rounded-lg mb-3" required>
                    <input type="password" name="password" id="authPassword" placeholder="Kata Sandi (min 6 karakter)" class="w-full p-3 border rounded-lg mb-4" required>
                    
                    <button type="submit" id="submitAuthBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Daftar</button>
                    <p id="authMessage" class="mt-3 text-center text-sm font-medium"></p>
                </form>

                <p class="text-center text-sm mt-4">
                    <button id="toggleAuthMode" class="text-indigo-600 hover:text-indigo-800">Sudah punya akun? Masuk di sini.</button>
                </p>
                <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
            </div>
        </div>

    </main>
    
    <!-- 3. JAVASCRIPT & FIREBASE LOGIC -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // --- KONFIGURASI FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bisnisundangan-69025'; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB2CHJqYrwSVVwJsEc1Cosw3GKFRF6m8Fc",
            authDomain: "bisnisundangan-69025.firebaseapp.com",
            projectId: "bisnisundangan-69025",
            storageBucket: "bisnisundangan-69025.firebasestorage.app",
            messagingSenderId: "1061283170101",
            appId: "1:1061283170101:web:bde0c4990a3fc14b5bae7c"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- PATHS ---
        const USER_METADATA_PATH = 'profile'; 
        const INVITATION_DATA_PATH = 'invitation_data'; 
        const INVITATION_DOC_ID = 'current';

        let app, db, auth;
        let authMode = 'register'; // 'register' or 'login'

        // --- DOM Elements ---
        const authModal = document.getElementById('authModal');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const submitAuthBtn = document.getElementById('submitAuthBtn');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const registerFields = document.getElementById('registerFields');
        const authMessage = document.getElementById('authMessage');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const closeModal = document.getElementById('closeModal');
        const etalaseSection = document.getElementById('etalaseSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const invitationForm = document.getElementById('invitationForm');
        const saveDataBtn = document.getElementById('saveDataBtn');
        const saveStatus = document.getElementById('saveStatus');
        const dashboardUserId = document.getElementById('dashboardUserId');
        const userBaseLink = document.getElementById('userBaseLink');
        const copyBaseLinkBtn = document.getElementById('copyBaseLinkBtn');
        const previewLinks = document.getElementById('previewLinks');
        
        // --- Initialization ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in anonymously first if no custom token exists, or use custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else if (!auth.currentUser) {
                     await signInAnonymously(auth); 
                }

                // Setup Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        handleLoginState(user.uid);
                    } else {
                        handleLogoutState();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }
        
        // --- State Handlers ---
        function handleLoginState(uid) {
            registerBtn.classList.add('hidden');
            loginBtn.classList.add('hidden');
            dashboardBtn.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            etalaseSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');

            dashboardUserId.textContent = `User ID: ${uid}`;
            const baseUrl = window.location.origin + window.location.pathname;
            userBaseLink.textContent = baseUrl + '?to=Nama_Tamu';
            
            updatePreviewLinks(uid);
            loadInvitationData(uid);
            hideModal();
        }

        function handleLogoutState() {
            registerBtn.classList.remove('hidden');
            loginBtn.classList.remove('hidden');
            dashboardBtn.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            etalaseSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
        }

        // --- Modal & Form Logic ---
        function showModal(mode) {
            authMode = mode;
            authTitle.textContent = mode === 'register' ? 'Daftar Akun' : 'Masuk Akun';
            submitAuthBtn.textContent = mode === 'register' ? 'Daftar' : 'Masuk';
            registerFields.classList.toggle('hidden', mode === 'login');
            toggleAuthModeBtn.textContent = mode === 'register' ? 'Sudah punya akun? Masuk di sini.' : 'Belum punya akun? Daftar di sini.';
            authMessage.textContent = '';
            authForm.reset();
            authModal.classList.remove('hidden');
            authModal.classList.add('flex');
        }

        function hideModal() {
            authModal.classList.add('hidden');
            authModal.classList.remove('flex');
        }

        registerBtn.addEventListener('click', () => showModal('register'));
        loginBtn.addEventListener('click', () => showModal('login'));
        toggleAuthModeBtn.addEventListener('click', () => showModal(authMode === 'register' ? 'login' : 'register'));
        closeModal.addEventListener('click', hideModal);
        dashboardBtn.addEventListener('click', () => { 
            etalaseSection.classList.add('hidden'); 
            dashboardSection.classList.remove('hidden'); 
        });

        // --- Auth Submission ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authForm.authEmail.value;
            const password = authForm.authPassword.value;
            submitAuthBtn.disabled = true;
            authMessage.textContent = '';

            try {
                if (authMode === 'register') {
                    const name = authForm.authName.value;
                    const phone = authForm.authPhone.value;
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Save user metadata to Firestore
                    await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/${USER_METADATA_PATH}`, 'metadata'), {
                        name: name,
                        email: email,
                        phone: phone,
                        created: new Date().toISOString()
                    });
                    authMessage.textContent = 'Pendaftaran berhasil! Mengalihkan ke Dashboard...';
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    authMessage.textContent = 'Masuk berhasil! Mengalihkan ke Dashboard...';
                }
            } catch (error) {
                console.error("Auth Error:", error);
                authMessage.textContent = `Error: ${error.message}`;
            } finally {
                submitAuthBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // After sign out, the onAuthStateChanged listener handles handleLogoutState()
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });

        // --- Data Handling ---
        const templateList = [
            { name: "Jawa Keraton Premium", file: "tema_jawa.html", color: "bg-amber-600", placeholder: "https://placehold.co/400x700/583925/F0EAD6?text=Jawa+Keraton" },
            { name: "Minimalis Modern", file: "tema_minimalis.html", color: "bg-gray-800", placeholder: "https://placehold.co/400x700/1a1a1a/ffffff?text=Minimalis+Modern" },
            { name: "Luxury Black & Gold", file: "tema_gold_black.html", color: "bg-yellow-700", placeholder: "https://placehold.co/400x700/111827/FFD700?text=Black+Gold+Luxury" },
            { name: "Classic Navy Elegance", file: "tema_classic_vintage.html", color: "bg-blue-800", placeholder: "https://placehold.co/400x700/001F3F/C0C0C0?text=Classic+Navy" },
        ];

        function updatePreviewLinks(uid) {
            previewLinks.innerHTML = '';
            const baseUrl = window.location.origin + window.location.pathname.replace('index.html', ''); // Get base path
            
            templateList.forEach(template => {
                const link = `${baseUrl}${template.file}?user=${uid}`;
                const element = `
                    <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-800">${template.name}</p>
                        <a href="${link}" target="_blank" class="text-sm px-3 py-1 rounded-full text-white ${template.color} hover:opacity-90 transition">Preview</a>
                    </div>
                `;
                previewLinks.innerHTML += element;
            });
        }
        
        async function loadInvitationData(uid) {
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${uid}/${INVITATION_DATA_PATH}`, INVITATION_DOC_ID);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Fill form with existing data
                    invitationForm.wanitaPanggilan.value = data.wanitaPanggilan || '';
                    invitationForm.priaPanggilan.value = data.priaPanggilan || '';
                    invitationForm.wanitaLengkap.value = data.wanitaLengkap || '';
                    invitationForm.priaLengkap.value = data.priaLengkap || '';
                    invitationForm.wanitaOrtu.value = data.wanitaOrtu || '';
                    invitationForm.priaOrtu.value = data.priaOrtu || '';
                    invitationForm.tglAkad.value = data.tglAkad || '';
                    invitationForm.tglResepsi.value = data.tglResepsi || '';
                    invitationForm.alamatAcara.value = data.alamatAcara || '';
                    invitationForm.linkMaps.value = data.linkMaps || '';
                    invitationForm.rekArif.value = data.rekArif || '';
                    invitationForm.rekVuah.value = data.rekVuah || '';
                    invitationForm.alamatKado.value = data.alamatKado || '';
                    saveStatus.textContent = 'Data berhasil dimuat. Terakhir disimpan: ' + new Date(data.savedAt).toLocaleString();
                    saveStatus.classList.remove('text-red-600');
                    saveStatus.classList.add('text-green-600');
                } else {
                    saveStatus.textContent = 'Belum ada data undangan. Silakan isi form di bawah.';
                    saveStatus.classList.remove('text-green-600');
                    saveStatus.classList.add('text-red-600');
                }
            } catch (error) {
                console.error("Error loading data:", error);
                saveStatus.textContent = 'Gagal memuat data. Periksa koneksi atau konsol.';
                saveStatus.classList.remove('text-green-600');
                saveStatus.classList.add('text-red-600');
            }
        }

        invitationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = auth.currentUser?.uid;
            if (!uid) { 
                saveStatus.textContent = 'Anda harus login untuk menyimpan.'; 
                saveStatus.classList.add('text-red-600');
                return; 
            }

            const formData = {
                wanitaPanggilan: invitationForm.wanitaPanggilan.value,
                priaPanggilan: invitationForm.priaPanggilan.value,
                wanitaLengkap: invitationForm.wanitaLengkap.value,
                priaLengkap: invitationForm.priaLengkap.value,
                wanitaOrtu: invitationForm.wanitaOrtu.value,
                priaOrtu: invitationForm.priaOrtu.value,
                tglAkad: invitationForm.tglAkad.value,
                tglResepsi: invitationForm.tglResepsi.value,
                alamatAcara: invitationForm.alamatAcara.value,
                linkMaps: invitationForm.linkMaps.value,
                rekArif: invitationForm.rekArif.value,
                rekVuah: invitationForm.rekVuah.value,
                alamatKado: invitationForm.alamatKado.value,
                savedAt: new Date().toISOString()
            };

            saveDataBtn.disabled = true;
            saveDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...';

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${uid}/${INVITATION_DATA_PATH}`, INVITATION_DOC_ID);
                await setDoc(docRef, formData);
                saveStatus.textContent = 'Data berhasil disimpan! ' + new Date().toLocaleString();
                saveStatus.classList.remove('text-red-600');
                saveStatus.classList.add('text-green-600');
                updatePreviewLinks(uid);
            } catch (error) {
                console.error("Error saving data:", error);
                saveStatus.textContent = `Gagal menyimpan data. Error: ${error.message}`;
                saveStatus.classList.remove('text-green-600');
                saveStatus.classList.add('text-red-600');
            } finally {
                saveDataBtn.disabled = false;
                saveDataBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Simpan Data Undangan';
            }
        });

        copyBaseLinkBtn.addEventListener('click', () => {
            const textToCopy = userBaseLink.textContent;
            const tempInput = document.createElement("textarea");
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            copyBaseLinkBtn.innerHTML = '<i class="fas fa-check"></i> Disalin!';
            setTimeout(() => { copyBaseLinkBtn.innerHTML = '<i class="fas fa-copy"></i>'; }, 1000);
        });
        
        // --- Start App ---
        initializeFirebase();
    </script>
</body>
</html>
